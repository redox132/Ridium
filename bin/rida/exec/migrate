<?php

#!/usr/bin/env php

use App\Database\Connection;
require_once __DIR__ . '/../../../vendor/autoload.php';

$pdo = Connection::getPDO();
$migrationsDir = __DIR__ . '/../../../app/database/migrations';

if (!is_dir($migrationsDir)) {
    echo "Migrations folder not found.\n";
    exit(1);
}

// Create `migrations` table if it doesn't exist
$pdo->exec("CREATE TABLE IF NOT EXISTS migrations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    batch INT NOT NULL,
    migrated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)");

$files = array_diff(scandir($migrationsDir), ['.', '..']);

// Get already run migrations
$ran = $pdo->query("SELECT name FROM migrations")->fetchAll(PDO::FETCH_COLUMN);
$batch = $pdo->query("SELECT MAX(batch) FROM migrations")->fetchColumn() + 1;

foreach ($files as $file) {
    if (in_array($file, $ran)) continue;

    $migration = require "$migrationsDir/$file";
    echo "Running: $file\n";
    $migration->up($pdo);

    $stmt = $pdo->prepare("INSERT INTO migrations (name, batch) VALUES (?, ?)");
    $stmt->execute([$file, $batch]);
}

echo "All migrations applied.\n";
